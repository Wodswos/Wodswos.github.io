

一般来说，内存（随机存储器）被视为主存储器。相应地，硬盘等存储设备也被称为辅助存储器（Secondary Memory）。

# 机械硬盘[^4][^2]

机械硬盘，即磁盘。

磁盘的读写是以扇区（512字节）为最小单位的，即使不足512字节。

## 磁盘结构

![image-20210524193752248](C:\Users\Five\Desktop\note\img\image-20210524193752248.png)

![](C:/Users/Five/Desktop/note/img/2843224-46fb935cd31addbd.png)

* 每个硬盘由重叠的一组盘片构成
* 每个盘片被划分为数目相等的磁道
  * 从外到里依次递增编号
    * 所有盘片上相同编号的磁道构成一个柱面
  * 每个盘面都有自己的磁头，盘面数等于磁头数。
  * 盘片数也即柱面磁道数
* 每个磁道划分为数量相等的扇区

> 磁盘大概可以类比为带z轴的极坐标系？
>
> 盘片/磁头是Z坐标，柱面/磁道是R，扇区号是θ，

早期的铝盘直径达50cm，但现在一般也就3-9cm，用于笔记本的磁盘直径已经在3cm以下。



### 磁道

磁道在物理上并不是磁盘表面的凹槽，而只是简单地由磁性材料组成地圆环，中间有隔离区将磁道和它相邻地磁道隔开。

圆的周长$C=2\pi R$，很显然外圈的磁道比里圈的磁道要长。旧式磁盘中，通过提高里圈的磁颗粒密度，降低外圈的磁颗粒密度来达到平衡。即不管里圈还是外圈，每个扇区占据相同的角度，每一圈的扇区数自然也相同。

新的策略中，里圈和外圈磁道不再拥有相同数量的扇区。将磁道从里到外划分为若干区域，靠外的区域内的磁道的扇区数相比靠内的区域内的磁道的扇区数更多。如下图所示

![image-20210524195549294](C:\Users\Five\Desktop\note\img\image-20210524195549294.png)

### 扇区

下图源自《Structured Computer Organization》

![image-20210524193617687](C:\Users\Five\Desktop\note\img\image-20210524193617687.png)

众所周知，每个扇区一般可存放512字节，存放这512字节数据的部分被称为数据区。

数据区前还有用于在读写之前对磁头进行的前导区（preamble），在数据区之后还有纠错码（Error-Correcting Code，ECC），即Hamming码或者更常用的能纠多个错的Reed-Solomon码。



在每个扇区之间是隔离带（intersector gap）。

> 柱面/磁道和磁头都是从0开始编号的，但扇区却是从1开始编号的，一般这被认为是第一个BIOS程序员的错误造成的，但也一路被兼容下来了。

## IDE盘

现代个人计算机的硬盘最早是从IBM PC XT的10MB Seagate硬盘发展而来，其控制器是Xebec磁盘控制器。

Seagate硬盘有4个磁头，306个柱面，没到有17个扇区，控制器可同时管理两块硬盘。操作系统通过BIOS对硬盘进行读写。[^8]

20实际80年代中叶，控制器和驱动器融合为集成驱动器电路，即Integrated Drive Electronic，IDE.



### CHS

《Structured Computer Organization》中说最早的程序是分配磁头号4bit，扇区号6bit，柱面号10bit。于是考虑到扇区的编号问题，总共最多能寻址1032392个扇区，504MiB容量。

一般认为CHS的分配是磁头号8bit，一共24bit，标称8.4GB（不到8GiB）[^7]

> 后来好像还扩展到了28bit？

这种直接访问硬盘的模式称为CHS模式（Cylinder-Head-Sector，柱面-磁头-扇区）。

> Unfortunately, before too long, drives below 504 MB appeared but with the wrong geometry (e.g., 4 heads, 32 sectors, 2000 cylinders is 256,000 sectors). There was no way for the operating system to address them due to the long-frozen BIOS calling conventions. As a result, disk controllers began to lie, pretending that the geometry was within the BIOS limits but actually remapping the virtual geometry onto the real geometry. Although this approach worked, it wreaked havoc with operating systems that carefully placed data to minimize seek times.[^2]
>
> 《Structured Computer Organization》的这段话没怎么读懂，但不打算继续深究。

### EIDE和LBA

随着硬盘存储密度的增大，引入了逻辑块地址（Logical Block Address，LBA）的概念

最早的LBA28使用28个bit表示逻辑扇区号，可管理从0到$2^{28}-1$的扇区号，即$2^{37} = 128G$的硬盘。很快，28bit不够用，又推出了LBA48，最多可以管理131072TB硬盘容量。

逻辑扇区号 =  每柱面磁头数（盘片数） × 每磁道扇区数 × 柱面号 + 每磁道扇区数 × 磁头号 + 扇区号 - 1。（这里的-1还是因为那个历史遗留问题）。如下图所示

![](C:/Users/Five/Desktop/note/img/v2-c1f894dca846db8b305c71a07adbe75b_1440w.png)



### ATAPI和SATA

Serial Advanced Technology Attachment，PC机硬盘的趋势，基本取代了传统PATA硬盘。

由Intel、APT、Dell、IBM、希捷、迈拓这几大厂商组成的Serial ATA委员会正式确立了Serial ATA 1.0规范，2002年，虽然串行ATA的相关设备还未正式上市，但Serial ATA委员会已抢先确立了Serial ATA 2.0规范。





## SCSI盘

Small Computer System Interface



由于SCSI硬盘的传输速率比较高，故成为许多高端的工作站和服务器的标准磁盘接口。

SCSI不仅仅是一种硬盘接口，还是一条最多可连接7个SCSI设备的总线。

## RAID盘

1988年，Patterson等在他们的一篇文章中建议用6个特定的磁盘组织来提高磁盘的性能或可靠性。[^2]

Patterson将RAID定义为Redundant Arrays of Inexpensive Disks。工业界更多的将RAID中的I理解为Independent而不是Inexpensive。

> Since a villain was also needed (as in RISC versus CISC, also due to Patterson), the bad guy here was the SLED (Single Large Expensive Disk).

![image-20210524211810136](C:\Users\Five\Desktop\note\img\image-20210524211810136.png)

* Level0：无冗余，并行I/O
* Level1：有冗余，更好的并行I/O，高可靠
* Level2：半字、字节为单位，利用汉明码保障可靠性
  * CM-2计算机（Connection Machine）
  * 听说IBM也有过这样的固定磁头设计
* Level3：纠错码换为简单的奇偶检验
* Level4：以strip为单位，同一行的strip一起异或，其结果作为校验码放到校验磁盘
* Level5：在阵列中循环分布校验码，从而避免Level4中校验磁盘成为性能瓶颈的情况

# ROM和固态硬盘

> 对于360管家热衷的打招呼方式——开机速度而言，主要影响因素是硬盘，而不是CPU和内存。

> 其实应该先写/看后一节机械硬盘的内容，但我还是把固态硬盘的内容放到了前面。

## ROM起家史

* ROM（Read-Only Memory，只读存储器）
* PROM（Programmable read-only memory，可编程只读存储器）
* EPROM（Erasable Programmable Read-Only Memory，可擦除可编程只读存储器）。

ROM信息一旦写入后就固定下来，相当于只能读出无法写入信息，即使切断电源，信息也不会丢失。

> 当然也不是完全无法写入（不然第一次写入是怎么写的呢），只是很麻烦。
>
> 之所以命名为Read-Only Memory的意思就是告诉你，我的主要任务不包括读写中的写，而是作为一种非易失性存储介质用来读的。你要频繁读写请另寻高明，如RAM。

EPROM由以色列工程师Dov Frohman发明，是一种断电后仍能保留数据的计算机储存芯片——即非易失性的。

它是一组浮栅晶体管，被一个提供比电子电路中常用电压更高电压的电子器件分别编程。一旦编程完成后，EPROM只能用强紫外线照射来擦除。



## EEPROM和闪存[^5]

EEPROM，Electronically Erasable Programmable Read-Only Memory，电可擦除可编程只读存储器。于1978年问世。

Flash Memory，闪存





与其他EEPROM技术类似，对闪存的写操作可以使存储位损耗。

### NOR和NAND

NOR和NAND不算是缩写（害，说来惭愧，一个软工狗误入CS，就是啥也不懂，全靠百度谷歌养活）。

NOR是NOT OR，即NOR里的单元是按照所谓或非的方式连起来的；NAND是NOT AND，即按照与非的方式连接单元。



日本的富士雄1980年申请了一个simultaneously erasable EEPROM的专利，因为种种原因，4年后才生产样品并参加了IEEE大会。

Intel在看到样品后开始全力研发自己的版本，并于1988年开发出了NOR Flash技术。

富士雄也没有就此停止，在1986年发明了NAND Flash。1989年，东芝公司发表了NAND Flash 结构，强调降低每比特的成本，有更高的性能，并且像磁盘一样可以通过接口轻松升级。



> 不管是NOR还是NAND，写入前都需要擦除。
>
> NOR Flash的一个bit可以从1变成0，而要从0变1就要擦除整块。NAND flash都需要擦除。

NOR Flash和普通的内存比较像的一点是他们都可以支持随机访问，这使它也具有支持XIP（eXecute In Place）的特性，可以像普通ROM一样执行程序。这点让它成为BIOS等开机就要执行的代码的绝佳载体。[^5]

现在几乎所有的BIOS和一些机顶盒上都是使用NOR Flash，它的大小一般在1MB到32MB之间，价格昂贵。[^5]

NAND Flash广泛应用在各种存储卡，U盘，SSD，eMMC等等大容量设备中。它的颗粒根据每个存储单元内存储比特个数的不同，可以分为 SLC（Single-Level Cell）、MLC（Multi-Level Cell） 和 TLC（Triple-Level Cell） 三类。其中，在一个存储单元中，SLC 可以存储 1 个比特，MLC 可以存储 2 个比特，TLC 则可以存储 3 个比特。[^5]

NAND Flash 的单个存储单元存储的比特位越多，读写性能会越差，寿命也越短，但是成本会更低。[^5]

### 破事一箩筐[^6]

UFS（Universal Flash Storage）是为了替代eMMC而生



NVMe（NVM Express）的目标是取代SATA SSD硬盘接口，主要应用在计算机平台。

NVMe实际上是通讯协议的一部分，在通讯协议里是应用层，使用PCIe协议作为数据和链路层。

NVMe是为SSD而生。在此之前SSD都用SATA接口。AHCI只有1个命令队列，队列深度32；而NVMe可以有65535个队列，每个队列都可以深达65536个命令。





### FTL

FTL，Flash translation layer

一种软件中间层，最初由intel提出，用于将闪存模拟成虚拟块设备，从而能够在闪存上实现FAT等块设备类文件系统。



FTL包含了地址映射，垃圾回收，损耗均衡等等几个方面的内容。

## SSD[^4]

Solid State Disk/Solid State Driver，俗称固态硬盘

### 存储单元

![image-20210524200056243](C:\Users\Five\Desktop\note\img\image-20210524200056243.png)

# 其他

## 虚拟硬盘[^1]

虚拟硬盘只是一个文件，有VDI、VHD、VHDX、HDD等格式。

要访问硬盘，运行中的程序至少要向硬盘控制器提k供4个参数：磁头号、磁道号、扇区号、访问意图（读或写）。

在VHD规范里，也和传统的硬盘一样，每个扇区512字节。在VHD文件最开始512字节即对应物理硬盘的0面0道1扇区，并依此类推。

在`.vhd`文件的结尾，包含了512字节的格式信息，格式信息以一个字符串`conectix`开始（好像是因为connectix公司？），用以标志该文件是VHD格式的虚拟硬盘。

在字符串之后是vhd文件的创建日期、CHD版本、创建该文件的应用程序名称和版本、操作系统、虚拟硬盘的参数（磁头数、磁道数、扇区数等）、VHD类型（固定尺寸or动态增长）等基本信息。

下图是Hyper-V新建虚拟硬盘的示意图。

![image-20210302130851942](C:\Users\Five\Desktop\note\img\image-20210302130851942.png)



## 关于单位前缀

![image-20210324150242678](C:\Users\Five\Desktop\note\img\image-20210324150242678.png)

耳熟能详国际单位制有长度、质量、时间等物理量，而国际单位制的前缀有k、M、G、T，分别代表$10^3,10^6,10^9,10^{12}$，后续又增加了P、E、Z、Y等单位前缀，依次递增1000倍。

当然也有反向的前缀，m、$\mu$（micro，微，前缀中唯一的非拉丁字符）、n（纳）、p（皮）、f（飞）、a（阿）、z（仄）、y（幺）。



计算机内部存储器容量标记没有遵守国际单位制要求，而是用了$2^{10}$作为近似，外部存储器容量则遵守了国际单位制的标准。

数据传输率、时钟频率等也依旧用国际单位制标准。



IEC 60027-2 A.2 ISO/IEC 80000定义Ki、Mi、Gi等一系列前缀，用于表示1024的底。









## 刷机

软刷

卡刷

线刷

厂刷

越狱



## 光盘[^3]

![image-20210524153032211](C:\Users\Five\Desktop\note\img\image-20210524153032211.png)



* CD（Compact Disk）
* DVD（Digital Video Disk）
* HD DVD（High Definition DVD）
  * 2008年，随着原先支持HD DVD的华纳公司宣布脱离HD DVD，以及美国数家连锁卖场决定支持蓝光产品，东芝公司终在2月19日正式宣布将终止HD DVD事业。
* BD（Blu-ray Disk）
  * 可以在记录层上叠加记录层，通过改变激光焦距读取各层数据



由于光盘记录信息的特殊性，无法记录两个连续的1。持续读取0也会因为长距离的平地/凹坑而失去方向，导致光头出轨。

于是就有了，Eight-toFourteen Modulation，EFM，八比十四调制。在该标准中

* 1不能连续出现
* 连续的0只能有2-10个

如此一来，14bit共16384个编码，从中选取256个符合规则的可用的编码，对应8bit的信息。

为了防止相邻编码的1首位相接，每个编码结尾还要加入3位耦合码。即最终用17bit表示8bit。



蓝光使用17PP调制码，编码率从47.06%提升到了66.67%



## 软盘

相比于硬盘，光盘已经比较少见了，软盘就更是几乎被淘汰了。





[^1]: 《x86汇编语言：从实模式到保护模式》
[^2]:《Structured Computer Organization》
[^3]:【回形针PaperClip】光盘里究竟有什么？https://www.bilibili.com/video/BV1K54y1q7Mr  
[^4]:【回形针PaperClip】你的硬盘是如何储存数据的？ https://www.bilibili.com/video/BV1n4411G7s5
[^5]: 杂谈闪存二：NOR和NAND Flash - 老狼的文章 - 知乎 https://zhuanlan.zhihu.com/p/26745577
[^6]: 杂说闪存一：关公战秦琼之 UFS VS NVMe - 老狼的文章 - 知乎 https://zhuanlan.zhihu.com/p/26652622
[^7]: 逻辑扇区和物理扇区的对应关系有点不懂？ - 木头龙的回答 - 知乎 https://www.zhihu.com/question/67935624/answer/258057176
[^8]:《计算机组成：结构化方法》Andrew S. Tanenbaum, Todd Austin


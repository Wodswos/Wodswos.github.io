# 文件系统

> 文件系统是操作系统相关的，也就是说一块挂载在Windows系统的硬盘，他会用Windows的格式存储其内容，重新挂载到一个Linux的系统，在不借助第三方工具的情况下是无法正常读取的。

## FAT[^1]

FAT，File Allocation Tables，文件分配表。

在存储空间的最开始有个大表，记录所有的可用块的的使用链，并标记空闲块和坏块。



波澜壮阔的硬件进化史和软件适配史：

上世纪80年代，磁盘只有几十KB，FAT12最多能支持16MB，可以说绰绰有余

很快磁盘扩张到了几十MB，不慌，1987年，DOS 3.3推出FAT16，最多支持2GB，可以说高枕无忧

磁盘继续扩张，1996，FAT32发布，最大支持2TB容量，嚯，小逼崽子你再跟上试试。

试试就逝世，就现在而言，2TB以上的硬盘并不少见。

> 你说这是微软对于科技的发展没有预料嘛？是短视嘛？还有Intel，为了4M寻址空间，采用20根地址线，进而引入段机制，放现在来看——4M够干啥的。
>
> 其实也未必，可能就是单纯的“可以但没必要”？
>
> 就算是现在，很多设计也是基于当前的水平来进行的——或者说，设计这件事本身就是根据当前的资源制定合适的方案。
>
> 过度设计——可以但没必要（甚至不可以）。当然那个年代的半导体和存储设备如磁盘确实增长快得略微离谱。

### FAT32

* 最大单文件大小容量为4GB



### exFAT

微软自家创建的用来取代FAT32文件格式的新型文件格式，最大可支持1EB大小的文件。



### 和UEFI

UEFI规定UEFI系统分区EFI system partition (ESP)采用FAT32格式，同时支持FAT12/FAT16作为移动介质的文件系统。



## NTFS

New Technology File System。

在大部分情况下都是文件系统的最优选

* 日志功能
* 无文件大小限制
* 支持文件压缩和长文件名
* 服务器文件管理权限

> Mac系统只能读取NTFS文件，但不支持写入，需要借助第三方工具。



## ext







## 闪存文件系统

JFFS/JFFS2、YAFFS、F2FS以及为苹果公司新提出的APFS。

NTFS对固态硬盘唯一的支持似乎只有从Windows 7开始加入的Trim指令支持。[^2]





# 文件系统架构



## 文件

* 文件
  * 文件系统中最大的数据单位，描述了一个对象集。
  * 在有结构的文件中，文件由若干个相关记录组成
  * 文件属性包括：类型、长度、物理位置、建立时间
* 记录
* 数据项



### 文件类型

文件可分成若干类型，如按用途分：系统文件、用户文件、库文件

按文件中数据的形式分：源文件、目标文件、可执行文件

按存储控制属性分：只执行文件、只读文件、读写文件。

按组织和处理方式分：普通文件、目录文件、特殊文件（特指I/O设备）。



### 文件逻辑结构

* 有利于提高检索记录速度和效率的逻辑结构形式
* 结构应方便对文件进行修改
* 降低文件存放在外村上的存储费用，不要求大片的连续存储空间



有结构文件：如信息管理系统、数据库系统

无结构文件：在系统中运行的大量源程序、可执行文件、库函数

无结构文件可以看作是记录式文件的特例：一个记录只有一个字节。



* 顺序文件
* 索引文件
* 索引顺序文件
* 直接文件和散列文件



### 文件物理结构

文件的组织形式主要有：

* 连续分配
* 链接分配
* 索引分配

## 目录、共享、保护



* 基于索引节点的共享方式（硬链接）
* 利用符号链实现文件共享（软链接）
  * 通过计算机网络，符号链可以链接世界上任何地方的计算机中的文件。



## 文件系统

文件系统是指操作系统中与文件管理有关的软件和数据的集合。



* 用户接口
* 文件目录系统
* 存取控制验证
* 逻辑文件系统与文件信息缓冲区
* 物理文件系统

### 文件的实现

#### 外存分配方式

* 连续分配
* 链接分配
  * 隐式链接
    * 每一盘块都附带有指向下一盘块的信息
  * 显式链接
    * 用于链接物理块的指针显式存在放在内存的一张链接表中，每个磁盘设置一张链接表
    * 该表称为文件分配表（File Allocation Table），即熟悉的FAT。（DOS、Windows等操作系统都用了FAT）
* 索引分配
  * 单级索引分配
  * 两级索引分配
  * 或和索引分配

#### 文件存储空间管理

* 空闲文件表
  * 将一个连续空闲区看作一个空闲文件。
  * 适合存储空间中只有少量空闲文件时使用。
* 空闲块链表
* 位示图法
  * 每一个二进制位对应一个物理块，0表示空闲
* 成组链接法（UNIX文件存储空间管理方法）
  * 把空闲块按每组100块分成若干组，把每一组的盘块数目和改组的所有盘块号记录到前一组的第一个盘块中，第一组的盘块数目和第一组的所有盘块号记入到超级块中。
  * 分配空闲盘块的方法
  * 空闲盘块回收的方法

# 磁盘管理

用柱面-磁头-扇区来唯一确定磁盘上的每一个区域。

每个扇区512字节。

## 磁盘调度算法

* FCFS
  * 优点：简单公平
  * 缺点：平均寻道时间较长
* SSTF
  * 优点：有较好的平均寻道时间
  * 缺点：并非最有，且可能会导致“饥饿”现象
* SCAN
  * 优点：较好地兼顾了寻到性能和防止“饥饿”现象
  * 缺点：存在一个请求刚好被错过而需要等待很久的情形
* C-SCAN
  * 消除了对两端磁道请求的不公平
  * 缺点：可能出现磁臂长期停留在某处的情况

## 文件存储空间管理





## 提高磁盘IO速度的途径



## 提高磁盘可靠性的技术





## 数据一致性控制

# I/O模型

### 阻塞式I/O

### 非阻塞式I/O

### I/O多路复用

Linux系统调用select函数

### 信号驱动I/O

epoll系统调用，介于IO多路复用和信号驱动IO之间。

### 异步I/O





### Linux零拷贝技术Zero Copy

数据在磁盘和网络进行传输时避免昂贵的内核态数据拷贝从而实现快速传输。





[^1]:FAT文件系统与UEFI - 老狼的文章 - 知乎 https://zhuanlan.zhihu.com/p/25992179
[^2]:在固态硬盘时代，NTFS 这种文件系统是不是已经很落后了？ - 木头龙的回答 - 知乎 https://www.zhihu.com/question/311478482/answer/600939889